function module_info {
if [ "$language" = "VN" ]; then
cat << !

        Tên: Phát hiện RCE CVE-2019-15107 Webmin
     Mô-đun: auxiliary/scanner/webapp/CVE-2019-15107_webmin_rce
   Nền tảng: Unix, Linux
    Công bố: 10/08/2019

Cung cấp bởi:
  @NIVEL4

Mục tiêu khả dụng:
   Id  Tên
   --  ----
   0   Webmin phiên bản từ 1.882 đến 1.921 và được bật "thay đổi mật khẩu người dùng"
!
module_compare
cat << !
Miêu tả:
   Lỗ hổng được bí mật chèn vào mã nguồn của máy chủ xây dựng Webmin bởi một hacker vô danh.
   Khi tính năng "cho phép thay đổi mật khẩu người dùng" được bật, tệp "password_change.cgi"
   gửi mật khẩu cũ đến hàm "encrypt_password" trong tệp "acl/acl-lib.pl" và gọi hàm "unix_crypt".
   Lổ hổng này tồn tại trong hàm mã hóa &unix_crypt. Hàm "unix_crypt" được gọi trong hàm 
   "xác thực mật mật khẩu cũ".Bằng cách sử dụng kí tự "|" để đọc file shadow trong quá trình
   xác thực mật khẩu cũ trông qua yêu cầu POST.
   Khi gửi một yêu cầu với POST data bình thường, chúng ta sẽ nhận được lỗi "Failed to change
   password: The current password is incorrect."
   Tệp "password_change.cgi" sẽ chỉ kiểm tra tham số "old" trên server mà không cần
   kiểm tra username có đúng hay không. Vì vậy, nếu thêm ký tự "|" trong POST data,
   chúng ta có thể chạy bất kỳ lệnh nào trên server thông qua hàm "password_change.cgi".

Tham khảo:
   http://www.webmin.com/exploit.html
   https://www.cvedetails.com/cve/CVE-2019-15107/
   https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2019-15107
   https://nvd.nist.gov/vuln/detail/CVE-2019-15107
   https://www.exploit-db.com/exploits/47293
   https://github.com/NIVEL4/exploits/tree/master/CVE-2019-15107

!
elif [ "$language" = "EN" ]; then
cat << !

       Name: RCE CVE-2019-15107 Webmin Detection
     Module: auxiliary/scanner/webapp/CVE-2019-15107_webmin_rce
   Platform: Unix, Linux
  Disclosed: 10/08/2019

Provided by:
  @NIVEL4

Available targets:
   Id  Name
   --  ----
   0   Webmin version 1.882 through 1.921 and enabled "user password change"
!
module_compare
cat << !
Description:
   The vulnerability was secretly inserted into the source code of the Webmin build server 
   by an anonymous hacker.
   When the "allow user password change" feature is enabled, the file "password_change.cgi" 
   sends the old password to the "encrypt_password" function in the "acl/acl-lib.pl" file
   and calls the "unix_crypt" function.
   This vulnerability exists in the &unix_crypt function. The "unix_crypt" function is called
   in the "old password authentication" function. By using the "|" to read the shadow file 
   during the old password authentication process via the POST request. When sending a request
   with normal POST data, we get the error "Failed to change password: The current password
   is incorrect."
   The file "password_change.cgi" will only check the "old" parameter on the server without
   checking whether the username is correct or not. So if adding the "|" character 
   in the POST data, we can run any command on the server via 
   the "password_change.cgi" function.

References:
   http://www.webmin.com/exploit.html
   https://www.cvedetails.com/cve/CVE-2019-15107/
   https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2019-15107
   https://nvd.nist.gov/vuln/detail/CVE-2019-15107
   https://www.exploit-db.com/exploits/47293
   https://github.com/NIVEL4/exploits/tree/master/CVE-2019-15107

!
fi

}
############ Hàm gán giá trị các biến #####################
function defaul_module_options {
	rhosts=""
	rport="10000"
	ssl="False"
	rhosts_lenght=18
}
############# Hàm kiểm tra chọn lựa để in ra màng hình ###############
function module_compare {
i_characters="i"
g_characters="g"	
_characters1="-"
_characters2="-"
if [[ $rhosts_lenght -le 18 ]]; then
	rhosts_lenght=18
fi
if  [[ "$rhosts_lenght" -le 18 ]]; then
		module1
else
		module2
fi
}
############### Hàm nhận giá trị nhận vào của biến ###################
function set_module {
		if [[ "$new_processing_variables" = "rhosts" ]] || [[ "$new_processing_variables" = "RHOSTS" ]] || [[ "$new_processing_variables" = "Rhosts" ]]; then
			unset rhosts
			rhosts="$module_set"
			rhosts_lenght=`echo $rhosts | awk '{print length}'`
			if [[ $rhosts_lenght -le 18 ]]; then
				rhosts_lenght=18
			fi
		elif [[ "$new_processing_variables" = "rport" ]] || [[ "$new_processing_variables" = "RPORT" ]] || [[ "$new_processing_variables" = "Rport" ]]; then
			unset rport
			rport="$module_set"
		elif [[ "$new_processing_variables" = "ssl" ]] || [[ "$new_processing_variables" = "SSL" ]] || [[ "$new_processing_variables" = "Ssl" ]]; then
			if [[ "$module_set" = "false" ]] || [[ "$module_set" = "FALSE" ]] || [[ "$module_set" = "False" ]]; then
				unset ssl
				ssl="$module_set"
			elif [[ "$module_set" = "true" ]] || [[ "$module_set" = "TRUE" ]] || [[ "$module_set" = "True" ]]; then
				unset ssl
				ssl="$module_set"
			else 	failed_to_validate=" $failed_validate'$module_set' $notvalid '$new_processing_variables'"
				echo -e "$red[-]$RESET" $failed_to_validate
			fi
		fi
}

##################### Hàm canh lề cho biến ###################
############# Khi các biến có độ dài nhỏ hơn 18 ###############
function module1 {
none=" "
myvar=""
	function unset_value {
		unset none
		unset myvar
		unset integer
		none=" "
		myvar=""
	}
rhosts=`echo $rhosts`
rhosts_lenght=`echo $rhosts | awk '{print length}'`
	integer=`expr 20 - $rhosts_lenght`			
	for (( i = 0 ; i < $integer; i++ )) do
		myvar=$myvar$none
	done
	rhosts=$rhosts$myvar
unset_value
rport=`echo $rport`
rport_lenght=`echo $rport | awk '{print length}'`
	integer=`expr 20 - $rport_lenght`			
	for (( i = 0 ; i < $integer; i++ )) do
		myvar=$myvar$none
	done
	rport=$rport$myvar
unset_value
ssl=`echo $ssl`
ssl_lenght=`echo $ssl | awk '{print length}'`
	integer=`expr 20 - $ssl_lenght`			
	for (( i = 0 ; i < $integer; i++ )) do
	myvar=$myvar$none
	done
	ssl=$ssl$myvar
unset_value
module_banner_1
}
function module2 {
none=" "
myvar=""
	function unset_value {
		unset none
		unset myvar
		unset subtract_compare_value
		none=" "
		myvar=""
	}
rhosts=`echo $rhosts`
rhosts_lenght=`echo $rhosts | awk '{print length}'`
greater_value=$rhosts_lenght
rport=`echo $rport`
rport_lenght=`echo $rport | awk '{print length}'`
subtract_compare_value=`expr $greater_value - $rport_lenght + 3`	
	for (( i = 0 ; i < $subtract_compare_value; i++ )) do
		myvar=$myvar$none
	done
	rport=$rport$myvar
unset_value
ssl=`echo $ssl`
ssl_lenght=`echo $ssl | awk '{print length}'`
subtract_compare_value=`expr $greater_value - $ssl_lenght + 3`	
	for (( i = 0 ; i < $subtract_compare_value; i++ )) do
		myvar=$myvar$none
	done
	ssl=$ssl$myvar
unset_value
subtract_compare_value=`expr $greater_value - 17 + 4`
for (( i = 0 ; i < $subtract_compare_value; i++ )) do
		myvar=$myvar$none
	done
	i_characters=$i_characters$myvar
unset_value
subtract_compare_value=`expr $greater_value - 17 + 4`
for (( i = 0 ; i < $subtract_compare_value; i++ )) do
		myvar=$myvar$none
	done
	g_characters=$g_characters$myvar
unset_value
subtract_compare_value=`expr $greater_value - 16 + 5`
for (( i = 0 ; i < $subtract_compare_value; i++ )) do
		myvar=$myvar$none
	done
	_characters1=$_characters1$myvar
unset_value
subtract_compare_value=`expr $greater_value - 16 + 3`
for (( i = 0 ; i < $subtract_compare_value; i++ )) do
		myvar=$myvar$none
	done
	_characters2=$_characters2$myvar
unset_value

module_banner_2
}
function module_banner_1 {
if [ "$language" = "VN" ]; then
yes="  Có"
no="  Không"
cat << !

Các tùy chọn của mô-đun (auxiliary/scanner/webapp/CVE-2019-15107_webmin_rce):

   Tên       	  Thiết lập hiện tại 	Yêu cầu   Miêu tả
   ----           --------------- 	--------  -----------
   RHOSTS         $rhosts $yes       Địa chỉ hoặc tên miền của máy chủ mục tiêu
   RPORT          $rport $no	  Cổng dịch vụ máy chủ Webmin đang chạy.
   SSL         	  $ssl $no	  Cho phép kết nối bằng SSL / TLS.
!
elif [ "$language" = "EN" ]; then
yes="  yes"
no="  no "
cat << !

Module options (auxiliary/scanner/webapp/CVE-2019-15107_webmin_rce):

   Name           Current Setting 	Required  Description
   ----           --------------- 	--------  -----------
   RHOSTS         $rhosts $yes      Address or domain name of target server.
   RPORT          $rport $no	  The Webmin server service port is running.
   SSL         	  $ssl $no	  Enable connection by SSL / TLS.
!
fi	
}
function module_banner_2 {
if [ "$language" = "VN" ]; then
yes="  Có"
no="  Không"
cat << !

Các tùy chọn của mô-đun (auxiliary/scanner/webapp/CVE-2019-15107_webmin_rce):

   Tên       	  Thiết lập hiện tạ${i_characters}Yêu cầu   Miêu tả
   ----       	  ---------------${_characters1}--------  -----------
   RHOSTS         $rhosts $yes       Địa chỉ hoặc tên miền của máy chủ mục tiêu
   RPORT          $rport $no    Cổng dịch vụ máy chủ Webmin đang chạy.
   SSL         	  $ssl $no    Cho phép kết nối bằng SSL / TLS.
!
elif [ "$language" = "EN" ]; then
yes="  yes"
no="  no "
cat << !

Module options (auxiliary/scanner/webapp/CVE-2019-15107_webmin_rce):

   Name           Current Setting${g_characters}Required  Description
   ----           ---------------${_characters2}--------  -----------
   RHOSTS         $rhosts $yes      Address or domain name of target server.
   RPORT          $rport $no	  The Webmin server service port is running.
   SSL         	  $ssl $no	  Enable connection by SSL / TLS.
!
fi
		
}
################# targets ###################
#############################################
function show_targets {
if [ "$language" = "VN" ]; then
cat << !
Các mục tiêu có thể khai thác:
   Id  Tên
   --  ----
   0   Webmin phiên bản từ 1.882 đến 1.921 và được bật "thay đổi mật khẩu người dùng"

!
elif [ "$language" = "EN" ]; then
cat << !
Exploit target:
   Id  Name
   --  ----
   0   Webmin version 1.882 through 1.921 and enabled "user password change"

!
fi
}

function target {
if [ "$language" = "VN" ]; then
cat << !
Các mục tiêu có thể khai thác:
   Id  Tên
   --  ----
   0   Webmin phiên bản từ 1.882 đến 1.921 và được bật "thay đổi mật khẩu người dùng"

!
elif [ "$language" = "EN" ]; then
cat << !
Exploit target:
   Id  Name
   --  ----
   0   Webmin version 1.882 through 1.921 and enabled "user password change"

!
fi
}
################# payload list ###################
#############################################
function payload_list {
echo -n ""
}
function out_value {
rhosts=`echo $rhosts`
rport=`echo $rport`
ssl=`echo $ssl`
if [[ "$ssl" = "true" ]] || [[ "$ssl" = "TRUE" ]] || [[ "$ssl" = "True" ]]; then
	s="https"
else
	s="http"
fi
file_ip="ip.txt"
}
function check {
echo -e "${red}[-]$RESET $not_module_check"
}
function module_run {
echo -n ""
}
function attack {
#####################
path_present=`pwd`
###################
out_value
path_tool="../../Tools/Vulnerability-Exploit/CVE-2019-15107/"
cd $path_tool
rm -rf $file_ip > /dev/null 2>&1
touch $file_ip > /dev/null 2>&1
check_none_rhosts=`echo $rhosts`
check_rhosts=`echo $rhosts | grep -e ";" -e ","`
if [[ "$check_rhosts" != "" ]]; then
	for (( i = 1 ; i <= 1000000; i++ )) do
		new_rhosts=`echo $rhosts | cut -d';' -f$i`
		if [[ "$new_rhosts" != "" ]]; then
			echo "$new_rhosts" >> $file_ip
		else
			break
		fi
	done		
elif [[ "$check_rhosts" = "" ]]; then
	if [[ "$check_none_rhosts" != "" ]]; then
		rhosts_analysis=${rhosts##*.} > /dev/null 2>&1
		head_rhosts=${rhosts%.*} > /dev/null 2>&1
		start_num=`echo $rhosts_analysis | cut -d'/' -f1` > /dev/null 2>&1
		stop_num=`echo $rhosts_analysis | cut -d'/' -f2` > /dev/null 2>&1
		if [ "$stop_num" != "" ]; then
			stop_num=`echo $stop_num` > /dev/null 2>&1
		else
			stop_num="0"
		fi
		check_num=`expr $start_num + $stop_num` > /dev/null 2>&1
		if [ "$check_num" != "" ]; then
			if [ "$check_num" = $start_num ]; then
				echo "$rhosts" >>  $file_ip
			else
				for (( i = $start_num ; i <= $stop_num; i++ )) do
					new_rhosts="$head_rhosts.$i" 
					echo "$new_rhosts" >> $file_ip
				done
			fi
		else 
			echo "$rhosts" >>  $file_ip
		fi
	fi
fi
echo -e "${BlueF}[*]$RESET $scan_start"
bash CVE-2019-15107_check.sh -p $rport -s $s
echo -e "${BlueF}[*]$RESET $scan_stop"
cd $path_present
}
