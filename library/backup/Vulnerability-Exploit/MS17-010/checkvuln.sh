#!/bin/bash
######Color##########
red='\e[1;31m'
yellow='\e[1;33m'
BlueF='\e[1;34m' #Biru
RESET="\033[00m" #normal
path=`pwd`
config_language="$path/../../../config/config-language"
source $config_language
################
file=ip.txt
attack_ip=aip.txt
rm -rf $attack_ip > /dev/null 2>&1
touch $attack_ip > /dev/null 2>&1
while getopts ":p:t:" opt; do
	case $opt in
		p)
			rport=$OPTARG   ##LOCAL HOST PORT
		;;
		t)
			time=$OPTARG
		;;
	esac
done	
  while IFS= read -r rhost
  do
	check=`python eternalblue-scanner.py $rhost $rport $time`
	check_vuln=`echo $check | awk '{print $1}'`
	check_reset_connection=`echo $check | grep "Connection reset by peer"`
	if [[ "$language" = "VN" ]]; then
		if [ "$check_vuln" = "VULNERABLE!" ]; then
			os_discovered=${check#* }
			echo "$rhost" >> $attack_ip
			echo -e "${yellow}[+]$RESET $rhost - Mục tiêu này có thể bị tấn công bởi lỗ hổng bảo mật ${red}MS17-010${RESET} !"
			echo -e "${BlueF}[*]$RESET $rhost - Hệ điều hành : Windows $os_discovered"
		elif [[ "$check_vuln" = "NOTVULNERABLE" ]] || [[ "$check_reset_connection" != "" ]]; then
			echo -e "${red}[-]$RESET $rhost - Mục tiêu này đã được vá lỗi hoặc không chịu ảnh hưởng của lỗ hổng này."
		else
			echo -e "${red}[-]$RESET $rhost - Máy chủ này hiện không mở hoặc có thể đã đổi cổng SMB."
		fi
	elif [[ "$language" = "EN" ]]; then
		if [ "$check_vuln" = "VULNERABLE!" ]; then
			os_discovered=${check#* }
			echo -e "${yellow}[+]$RESET $rhost - This target could be attacked by vulnerability ${red}MS17-010${RESET} !"
			echo -e "${BlueF}[*]$RESET $rhost - Operating System : Windows $os_discovered"
		elif [[ "$check_vuln" = "NOTVULNERABLE" ]] || [[ "$check_reset_connection" != "" ]]; then
			echo -e "${red}[-]$RESET $rhost - This target has been patched or is not affected by this vulnerability."
		else
			echo -e "${red}[-]$RESET $rhost - This server is currently not running or may have changed the SMB port."
		fi
	fi
  done < $file
