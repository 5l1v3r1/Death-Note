function module_info {
if [ "$language" = "VN" ]; then
cat << !

        Tên: Phát hiện MS17-010 smb
     Mô-đun: auxiliary/scanner/smb/MS17-010_smb_scan
   Nền tảng: Windows
    Công bố: 14/03/2017

Cung cấp bởi:
  @am0nsec

Mục tiêu khả dụng:
   Id  Tên
   --  ----
   #   Bao gồm các phiên bản Windows:
	   Windows Server 2016 for x64-based Systems
	   Windows 10 Version 1607 for 32-bit Systems
	   Windows 10 Version 1607 for x64-based Systems
	   Windows 10 version 1511 for 32-bit Systems
	   Windows 10 version 1511 for x64-based Systems
	   Windows 10 for 32-bit Systems
	   Windows 10 for x64-based Systems
	   Windows 7 for 32-bit Systems SP1
	   Windows 7 for x64-based Systems SP1
	   Windows 8 for x64-based Systems
	   Windows 8 for 32-bit Systems
	   Windows 8.1 for 32-bit Systems
	   Windows 8.1 for x64-based Systems
	   Windows RT 8.1
	   Windows Server 2012
	   Windows Server 2012 R2
	   Windows Server 2008 R2 for Itanium-based Systems SP1
	   Windows Server 2008 R2 for x64-based Systems SP1
	   Windows Server 2008 for 32-bit Systems SP2
	   Windows Server 2008 for Itanium-based Systems SP2
	   Windows Server 2008 for x64-based Systems SP2
	   Windows Vista Service Pack 2
	   Windows Vista x64 Edition Service Pack 2
	   Windows XP Embedded SP3 x86
	   Windows XP Sp2 X64
	   Windows XP Sp3 X86 
	   Windows Server 2003 x64 SP2
	   Windows Server 2003 x86 SP2
!
module_compare
cat << !
Miêu tả:
   Mô-dun phát hiện và kiểm tra lỗ hổng bảo mật MS17-010 hay còn được gọi
   là EternalBlue trong giao thức SMB (Server Message Block Protocol).

Tham khảo:
   https://docs.microsoft.com/en-us/security-updates/securitybulletins/2017/ms17-010
   https://cvedetails.com/cve/CVE-2017-0143/
   https://cvedetails.com/cve/CVE-2017-0144/
   https://cvedetails.com/cve/CVE-2017-0145/
   https://cvedetails.com/cve/CVE-2017-0146/
   https://cvedetails.com/cve/CVE-2017-0147/
   https://cvedetails.com/cve/CVE-2017-0148/
   https://github.com/am0nsec/exploit/tree/master/windows/smb/MS17-010-EternalBlue

Còn được biết là:
   EternalBlue DoublePulsar

!
elif [ "$language" = "EN" ]; then
cat << !

       Name: MS17-010 smb Detection
     Module: auxiliary/scanner/smb/MS17-010_smb_scan
   Platform: Windows
  Disclosed: 14/03/2017

Provided by:
  @am0nsec

Available targets:
   Id  Name
   --  ----
   #   Includes Windows versions:
	   Windows Server 2016 for x64-based Systems
	   Windows 10 Version 1607 for 32-bit Systems
	   Windows 10 Version 1607 for x64-based Systems
	   Windows 10 version 1511 for 32-bit Systems
	   Windows 10 version 1511 for x64-based Systems
	   Windows 10 for 32-bit Systems
	   Windows 10 for x64-based Systems
	   Windows 7 for 32-bit Systems SP1
	   Windows 7 for x64-based Systems SP1
	   Windows 8 for x64-based Systems
	   Windows 8 for 32-bit Systems
	   Windows 8.1 for 32-bit Systems
	   Windows 8.1 for x64-based Systems
	   Windows RT 8.1
	   Windows Server 2012
	   Windows Server 2012 R2
	   Windows Server 2008 R2 for Itanium-based Systems SP1
	   Windows Server 2008 R2 for x64-based Systems SP1
	   Windows Server 2008 for 32-bit Systems SP2
	   Windows Server 2008 for Itanium-based Systems SP2
	   Windows Server 2008 for x64-based Systems SP2
	   Windows Vista Service Pack 2
	   Windows Vista x64 Edition Service Pack 2
	   Windows XP Embedded SP3 x86
	   Windows XP Sp2 X64
	   Windows XP Sp3 X86 
	   Windows Server 2003 x64 SP2
	   Windows Server 2003 x86 SP2
!
module_compare
cat << !
Description:
   MS17-010 vulnerability detection and checking module is also known as BlueKeep
   in Remote Desktop Protocol.

References:
   https://docs.microsoft.com/en-us/security-updates/securitybulletins/2017/ms17-010
   https://cvedetails.com/cve/CVE-2017-0143/
   https://cvedetails.com/cve/CVE-2017-0144/
   https://cvedetails.com/cve/CVE-2017-0145/
   https://cvedetails.com/cve/CVE-2017-0146/
   https://cvedetails.com/cve/CVE-2017-0147/
   https://cvedetails.com/cve/CVE-2017-0148/
   https://github.com/am0nsec/exploit/tree/master/windows/smb/MS17-010-EternalBlue

Also known as:
   EternalBlue DoublePulsar

!
fi

}
############ Hàm gán giá trị các biến #####################
function defaul_module_options {
	rhosts=""
	rport="445"
	timeout="2"
	rhosts_lenght=18
}
############# Hàm kiểm tra chọn lựa để in ra màng hình ###############
function module_compare {
i_characters="i"
g_characters="g"	
_characters1="-"
_characters2="-"
if [[ $rhosts_lenght -le 18 ]]; then
	rhosts_lenght=18
fi
if [[ "$rhosts_lenght" -le 18 ]]; then
		module1
else
		module2
fi
}
############### Hàm nhận giá trị nhận vào của biến ###################
function set_module {
		if [[ "$new_processing_variables" = "rhosts" ]] || [[ "$new_processing_variables" = "RHOSTS" ]] || [[ "$new_processing_variables" = "Rhosts" ]] || [[ "$new_processing_variables" = "rhost" ]] || [[ "$new_processing_variables" = "RHOST" ]] || [[ "$new_processing_variables" = "Rhost" ]]; then
			unset rhosts
			rhosts="$module_set"
			rhosts_lenght=`echo $rhosts | awk '{print length}'`
			if [[ $rhosts_lenght -le 18 ]]; then
				rhosts_lenght=18
			fi
		elif [[ "$new_processing_variables" = "rport" ]] || [[ "$new_processing_variables" = "RPORT" ]] || [[ "$new_processing_variables" = "Rport" ]]; then
			unset rport
			rport="$module_set"
		elif [[ "$new_processing_variables" = "timeout" ]] || [[ "$new_processing_variables" = "TIMEOUT" ]] || [[ "$new_processing_variables" = "Timeout" ]]; then
			unset timeout
			timeout="$module_set"
		fi
}

##################### Hàm canh lề cho biến ###################
############# Khi các biến có độ dài nhỏ hơn 18 ###############
function module1 {
none=" "
myvar=""
	function unset_value {
		unset none
		unset myvar
		unset integer
		none=" "
		myvar=""
	}
rhosts=`echo $rhosts`
rhosts_lenght=`echo $rhosts | awk '{print length}'`
	integer=`expr 20 - $rhosts_lenght`			
	for (( i = 0 ; i < $integer; i++ )) do
		myvar=$myvar$none
	done
	rhosts=$rhosts$myvar
unset_value
rport=`echo $rport`
rport_lenght=`echo $rport | awk '{print length}'`
	integer=`expr 20 - $rport_lenght`			
	for (( i = 0 ; i < $integer; i++ )) do
		myvar=$myvar$none
	done
	rport=$rport$myvar
unset_value
timeout=`echo $timeout`
timeout_lenght=`echo $timeout | awk '{print length}'`
	integer=`expr 20 - $timeout_lenght`			
	for (( i = 0 ; i < $integer; i++ )) do
		myvar=$myvar$none
	done
	timeout=$timeout$myvar
unset_value
module_banner_1
}
function module2 {
none=" "
myvar=""
	function unset_value {
		unset none
		unset myvar
		unset subtract_compare_value
		none=" "
		myvar=""
	}
rhosts=`echo $rhosts`
rhosts_lenght=`echo $rhosts | awk '{print length}'`
greater_value=$rhosts_lenght
rport=`echo $rport`
rport_lenght=`echo $rport | awk '{print length}'`
subtract_compare_value=`expr $greater_value - $rport_lenght + 3`	
	for (( i = 0 ; i < $subtract_compare_value; i++ )) do
		myvar=$myvar$none
	done
	rport=$rport$myvar
unset_value
timeout=`echo $timeout`
timeout_lenght=`echo $timeout | awk '{print length}'`
subtract_compare_value=`expr $greater_value - $timeout_lenght + 3`	
	for (( i = 0 ; i < $subtract_compare_value; i++ )) do
		myvar=$myvar$none
	done
	timeout=$timeout$myvar
unset_value
subtract_compare_value=`expr $greater_value - 17 + 4`
for (( i = 0 ; i < $subtract_compare_value; i++ )) do
		myvar=$myvar$none
	done
	i_characters=$i_characters$myvar
unset_value
subtract_compare_value=`expr $greater_value - 17 + 4`
for (( i = 0 ; i < $subtract_compare_value; i++ )) do
		myvar=$myvar$none
	done
	g_characters=$g_characters$myvar
unset_value
subtract_compare_value=`expr $greater_value - 16 + 5`
for (( i = 0 ; i < $subtract_compare_value; i++ )) do
		myvar=$myvar$none
	done
	_characters1=$_characters1$myvar
unset_value
subtract_compare_value=`expr $greater_value - 16 + 3`
for (( i = 0 ; i < $subtract_compare_value; i++ )) do
		myvar=$myvar$none
	done
	_characters2=$_characters2$myvar
unset_value

module_banner_2
}
function module_banner_1 {
if [ "$language" = "VN" ]; then
yes="  Có"
no="  Không"
cat << !

Các tùy chọn của mô-đun (auxiliary/scanner/smb/MS17-010_smb_scan):

   Tên       	  Thiết lập hiện tại 	Yêu cầu   Miêu tả
   ----           --------------- 	--------  -----------
   RHOSTS         $rhosts $yes       Địa chỉ hoặc tên miền của máy chủ mục tiêu
   RPORT          $rport $no	  Cổng dịch vụ máy chủ smb đang chạy.
   TIMEOUT        $timeout $no	  Thời gian chờ phiên kết nối.

!
elif [ "$language" = "EN" ]; then
yes="  yes"
no="  no "
cat << !

Module options (auxiliary/scanner/smb/MS17-010_smb_scan):

   Name           Current Setting 	Required  Description
   ----           --------------- 	--------  -----------
   RHOSTS         $rhosts $yes      Address or domain name of target server.
   RPORT          $rport $no	  The smb server service port is running.
   TIMEOUT        $timeout $no	  Session timeout.

!
fi	
}
function module_banner_2 {
if [ "$language" = "VN" ]; then
yes="  Có"
no="  Không"
cat << !

Các tùy chọn của mô-đun (auxiliary/scanner/smb/MS17-010_smb_scan):

   Tên       	  Thiết lập hiện tạ${i_characters}Yêu cầu   Miêu tả
   ----       	  ---------------${_characters1}--------  -----------
   RHOSTS         $rhosts $yes       Địa chỉ hoặc tên miền của máy chủ mục tiêu
   RPORT          $rport $no    Cổng dịch vụ máy chủ smb đang chạy.
   TIMEOUT        $timeout $no	  Thời gian chờ phiên kết nối.

!
elif [ "$language" = "EN" ]; then
yes="  yes"
no="  no "
cat << !

Module options (auxiliary/scanner/smb/MS17-010_smb_scan):

   Name           Current Setting${g_characters}Required  Description
   ----           ---------------${_characters2}--------  -----------
   RHOSTS         $rhosts $yes      Address or domain name of target server.
   RPORT          $rport $no	  The smb server service port is running.
   TIMEOUT        $timeout $no	  Session timeout.

!
fi
		
}
################# targets ###################
#############################################
function show_targets {
if [ "$language" = "VN" ]; then
cat << !
Các mục tiêu có thể khai thác:
   Id  Tên
   --  ----
   0   Bao gồm các phiên bản Windows 64 bit và 32 bit của :
	   Windows Server 2016
	   Windows 10
	   Windows 8
	   Windows 8.1
	   Windows RT 8.1
	   Windows Server 2012
	   Windows Server 2012 R2
	   Windows Server 2008 R2
	   Windows 7
	   Windows Server 2008
	   Windows Vista
	   Windows XP
	   Windows 2003

!
elif [ "$language" = "EN" ]; then
cat << !
Exploit target:
   Id  Name
   --  ----
   0   Includes 64-bit and 32-bit versions of Windows:
	   Windows Server 2016
	   Windows 10
	   Windows 8
	   Windows 8.1
	   Windows RT 8.1
	   Windows Server 2012
	   Windows Server 2012 R2
	   Windows Server 2008 R2
	   Windows 7
	   Windows Server 2008
	   Windows Vista
	   Windows XP
	   Windows 2003

!
fi
}

function target {
if [ "$language" = "VN" ]; then
cat << !
Các mục tiêu có thể khai thác:
   Id  Tên
   --  ----
   0   Bao gồm các phiên bản Windows 64 bit và 32 bit của :
	   Windows Server 2016
	   Windows 10
	   Windows 8
	   Windows 8.1
	   Windows RT 8.1
	   Windows Server 2012
	   Windows Server 2012 R2
	   Windows Server 2008 R2
	   Windows 7
	   Windows Server 2008
	   Windows Vista
	   Windows XP
	   Windows 2003

!
elif [ "$language" = "EN" ]; then
cat << !
Exploit target:
   Id  Name
   --  ----
   0   Includes 64-bit and 32-bit versions of Windows:
	   Windows Server 2016
	   Windows 10
	   Windows 8
	   Windows 8.1
	   Windows RT 8.1
	   Windows Server 2012
	   Windows Server 2012 R2
	   Windows Server 2008 R2
	   Windows 7
	   Windows Server 2008
	   Windows Vista
	   Windows XP
	   Windows 2003

!
fi
}
################# payload list ###################
#############################################
function payload_list {
echo -n ""
}
function out_value {
rhosts=`echo $rhosts`
rport=`echo $rport`
timeout=`echo $timeout`
file_ip="ip.txt"
}
function check {
echo -e "[${red}-${RESET}] $not_module_check"
}
function module_run {
echo -n ""
}
function attack {
#####################
path_present=`pwd`
###################
out_value
path_tool="../../Tools/Vulnerability-Exploit/MS17-010/"
cd $path_tool
rm -rf $file_ip > /dev/null 2>&1
touch $file_ip > /dev/null 2>&1
check_none_rhosts=`echo $rhosts`
check_rhosts=`echo $rhosts | grep -e ";" -e ","`
if [[ "$check_rhosts" != "" ]]; then
	for (( i = 1 ; i <= 1000000; i++ )) do
		new_rhosts=`echo $rhosts | cut -d';' -f$i`
		if [[ "$new_rhosts" != "" ]]; then
			echo "$new_rhosts" >> $file_ip
		else
			break
		fi
	done		
elif [[ "$check_rhosts" = "" ]]; then
	if [[ "$check_none_rhosts" != "" ]]; then
		rhosts_analysis=${rhosts##*.} > /dev/null 2>&1
		head_rhosts=${rhosts%.*} > /dev/null 2>&1
		start_num=`echo $rhosts_analysis | cut -d'/' -f1` > /dev/null 2>&1
		stop_num=`echo $rhosts_analysis | cut -d'/' -f2` > /dev/null 2>&1
		if [ "$stop_num" != "" ]; then
			stop_num=`echo $stop_num` > /dev/null 2>&1
		else
			stop_num="0"
		fi
		check_num=`expr $start_num + $stop_num` > /dev/null 2>&1
		if [ "$check_num" != "" ]; then
			if [ "$check_num" = $start_num ]; then
				echo "$rhosts" >>  $file_ip
			else
				for (( i = $start_num ; i <= $stop_num; i++ )) do
					new_rhosts="$head_rhosts.$i" 
					echo "$new_rhosts" >> $file_ip
				done
			fi
		else 
			echo "$rhosts" >>  $file_ip
		fi
	fi
fi
echo -e "${BlueF}[*]$RESET $scan_start"
bash checkvuln.sh -p $rport -t $timeout
echo -e "${BlueF}[*]$RESET $scan_stop"
cd $path_present
}
