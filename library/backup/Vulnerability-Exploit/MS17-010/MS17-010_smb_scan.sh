function module_info {
if [ "$language" = "VN" ]; then
cat << !

        Tên: Phát hiện MS17-010 smb
     Mô-đun: auxiliary/scanner/smb/MS17-010_smb_scan
   Nền tảng: Windows
    Loại mã: Python
    Công bố: 14/03/2017

Cung cấp bởi:
   am0nsec
!
platform
cat << !

Mục tiêu khả dụng:

   Id  Tên
   --  ----
   0   Tự động điều chỉnh mục tiêu thông qua lấy dấu tay
       ,--------------------------------------------------------.
       |    Mục tiêu bao gồm các phiên bản Windows              |   
       |--------------------------------------------------------|
       |  Windows Server 2016 for x64-based Systems             |
       |  Windows 10 Version 1607 for 32-bit Systems            |
       |  Windows 10 Version 1607 for x64-based Systems         |
       |  Windows 10 version 1511 for 32-bit Systems            |
       |  Windows 10 version 1511 for x64-based Systems         |
       |  Windows 10 for 32-bit Systems                         |
       |  Windows 10 for x64-based Systems                      |
       |  Windows 7 for 32-bit Systems SP1                      |
       |  Windows 7 for x64-based Systems SP1                   |
       |  Windows 8 for x64-based Systems                       |
       |  Windows 8 for 32-bit Systems                          |
       |  Windows 8.1 for 32-bit Systems                        |
       |  Windows 8.1 for x64-based Systems                     |
       |  Windows RT 8.1                                        |
       |  Windows Server 2012                                   |
       |  Windows Server 2012 R2                                |
       |  Windows Server 2008 R2 for Itanium-based Systems SP1  |
       |  Windows Server 2008 R2 for x64-based Systems SP1      |
       |  Windows Server 2008 for 32-bit Systems SP2            |
       |  Windows Server 2008 for Itanium-based Systems SP2     |
       |  Windows Server 2008 for x64-based Systems SP2         |
       |  Windows Vista Service Pack 2                          |
       |  Windows Vista x64 Edition Service Pack 2              |
       |  Windows XP Embedded SP3 x86                           |
       |  Windows XP Sp2 X64                                    |
       |  Windows XP Sp3 X86                                    |
       |  Windows Server 2003 x64 SP2                           |
       |  Windows Server 2003 x86 SP2                           |
       '--------------------------------------------------------'  
!
module_compare
cat << !
Miêu tả:
   Mô-dun phát hiện và kiểm tra lỗ hổng bảo mật MS17-010 hay còn được gọi
   là EternalBlue trong giao thức SMB (Server Message Block Protocol).

Tham khảo:
   https://docs.microsoft.com/en-us/security-updates/securitybulletins/2017/ms17-010
   https://cvedetails.com/cve/CVE-2017-0143/
   https://cvedetails.com/cve/CVE-2017-0144/
   https://cvedetails.com/cve/CVE-2017-0145/
   https://cvedetails.com/cve/CVE-2017-0146/
   https://cvedetails.com/cve/CVE-2017-0147/
   https://cvedetails.com/cve/CVE-2017-0148/
   https://github.com/am0nsec/exploit/tree/master/windows/smb/MS17-010-EternalBlue

Còn được biết là:
   EternalBlue DoublePulsar

!
elif [ "$language" = "EN" ]; then
cat << !

       Name: MS17-010 smb Detection
     Module: auxiliary/scanner/smb/MS17-010_smb_scan
   Platform: Windows
  Disclosed: 14/03/2017

Provided by:
   am0nsec
!
platform
cat << !

Available targets:

   Id  Name
   --  ----
   0   Automatic targeting via fingerprinting
       ,--------------------------------------------------------.
       |    Targets includes Windows versions                   |   
       |--------------------------------------------------------|
       |  Windows Server 2016 for x64-based Systems             |
       |  Windows 10 Version 1607 for 32-bit Systems            |
       |  Windows 10 Version 1607 for x64-based Systems         |
       |  Windows 10 version 1511 for 32-bit Systems            |
       |  Windows 10 version 1511 for x64-based Systems         |
       |  Windows 10 for 32-bit Systems                         |
       |  Windows 10 for x64-based Systems                      |
       |  Windows 7 for 32-bit Systems SP1                      |
       |  Windows 7 for x64-based Systems SP1                   |
       |  Windows 8 for x64-based Systems                       |
       |  Windows 8 for 32-bit Systems                          |
       |  Windows 8.1 for 32-bit Systems                        |
       |  Windows 8.1 for x64-based Systems                     |
       |  Windows RT 8.1                                        |
       |  Windows Server 2012                                   |
       |  Windows Server 2012 R2                                |
       |  Windows Server 2008 R2 for Itanium-based Systems SP1  |
       |  Windows Server 2008 R2 for x64-based Systems SP1      |
       |  Windows Server 2008 for 32-bit Systems SP2            |
       |  Windows Server 2008 for Itanium-based Systems SP2     |
       |  Windows Server 2008 for x64-based Systems SP2         |
       |  Windows Vista Service Pack 2                          |
       |  Windows Vista x64 Edition Service Pack 2              |
       |  Windows XP Embedded SP3 x86                           |
       |  Windows XP Sp2 X64                                    |
       |  Windows XP Sp3 X86                                    |
       |  Windows Server 2003 x64 SP2                           |
       |  Windows Server 2003 x86 SP2                           |
       '--------------------------------------------------------'  
!
module_compare
cat << !
Description:
   MS17-010 vulnerability detection and checking module is also known as BlueKeep
   in Remote Desktop Protocol.

References:
   https://docs.microsoft.com/en-us/security-updates/securitybulletins/2017/ms17-010
   https://cvedetails.com/cve/CVE-2017-0143/
   https://cvedetails.com/cve/CVE-2017-0144/
   https://cvedetails.com/cve/CVE-2017-0145/
   https://cvedetails.com/cve/CVE-2017-0146/
   https://cvedetails.com/cve/CVE-2017-0147/
   https://cvedetails.com/cve/CVE-2017-0148/
   https://github.com/am0nsec/exploit/tree/master/windows/smb/MS17-010-EternalBlue

Also known as:
   EternalBlue DoublePulsar

!
fi

}
############ Hàm gán giá trị các biến #####################
function defaul_module_options {
	platform="Python"
	rhosts=""
	rport="445"
	timeout="2"
  check_run=0
	rhosts_lenght=18
}
############# Hàm kiểm tra chọn lựa để in ra màng hình ###############
function module_compare {
i_characters="i"
g_characters="g"	
_characters1="-"
_characters2="-"
if [[ $rhosts_lenght -le 18 ]]; then
	rhosts_lenght=18
fi
plus_strings=$rhosts_lenght
if [[ "$plus_strings" -le 18 ]]; then
		module1
else
		module2
fi
}
############### Hàm nhận giá trị nhận vào của biến ###################
function set_module {
		if [[ "$new_processing_variables" = "platform" ]] || [[ "$new_processing_variables" = "PLATFORM" ]] || [[ "$new_processing_variables" = "Platform" ]]; then
			if [[ "$module_set" = "python" ]] || [[ "$module_set" = "PYTHON" ]] || [[ "$module_set" = "Python" ]] || [[ "$module_set" = "py" ]] || [[ "$module_set" = "Py" ]] || [[ "$module_set" = "0" ]]; then
				unset platform
				platform="$module_set"
			else 	failed_to_validate=" $failed_validate'$module_set' $notvalid '$new_processing_variables'"
				echo -e "$red[-]$RESET" $failed_to_validate
			fi		
		elif [[ "$new_processing_variables" = "rhosts" ]] || [[ "$new_processing_variables" = "RHOSTS" ]] || [[ "$new_processing_variables" = "Rhosts" ]] || [[ "$new_processing_variables" = "rhost" ]] || [[ "$new_processing_variables" = "RHOST" ]] || [[ "$new_processing_variables" = "Rhost" ]]; then
			unset rhosts
			rhosts="$module_set"
			rhosts_lenght=`echo $rhosts | awk '{print length}'`
			if [[ $rhosts_lenght -le 18 ]]; then
				rhosts_lenght=18
			fi
		elif [[ "$new_processing_variables" = "rport" ]] || [[ "$new_processing_variables" = "RPORT" ]] || [[ "$new_processing_variables" = "Rport" ]]; then
			unset rport
			rport="$module_set"
		elif [[ "$new_processing_variables" = "timeout" ]] || [[ "$new_processing_variables" = "TIMEOUT" ]] || [[ "$new_processing_variables" = "Timeout" ]]; then
			unset timeout
			timeout="$module_set"
		fi
}

##################### Hàm canh lề cho biến ###################
############# Khi các biến có độ dài nhỏ hơn 18 ###############
function module1 {
none=" "
myvar=""
	function unset_value {
		unset none
		unset myvar
		unset integer
		none=" "
		myvar=""
	}
rhosts=`echo $rhosts`
rhosts_lenght=`echo $rhosts | awk '{print length}'`
	integer=`expr 20 - $rhosts_lenght`			
	for (( i = 0 ; i < $integer; i++ )) do
		myvar=$myvar$none
	done
	rhosts=$rhosts$myvar
unset_value
rport=`echo $rport`
rport_lenght=`echo $rport | awk '{print length}'`
	integer=`expr 20 - $rport_lenght`			
	for (( i = 0 ; i < $integer; i++ )) do
		myvar=$myvar$none
	done
	rport=$rport$myvar
unset_value
timeout=`echo $timeout`
timeout_lenght=`echo $timeout | awk '{print length}'`
	integer=`expr 20 - $timeout_lenght`			
	for (( i = 0 ; i < $integer; i++ )) do
		myvar=$myvar$none
	done
	timeout=$timeout$myvar
unset_value
module_banner_1
}
function module2 {
none=" "
myvar=""
	function unset_value {
		unset none
		unset myvar
		unset subtract_compare_value
		none=" "
		myvar=""
	}
rhosts=`echo $rhosts`
rhosts_lenght=`echo $rhosts | awk '{print length}'`
integer=3
for (( i = 0 ; i < $integer; i++ )) do
  myvar=$myvar$none
done
rhosts=$rhosts$myvar
greater_value=$rhosts_lenght
unset_value
rport=`echo $rport`
rport_lenght=`echo $rport | awk '{print length}'`
subtract_compare_value=`expr $greater_value - $rport_lenght + 3`  
	for (( i = 0 ; i < $subtract_compare_value; i++ )) do
		myvar=$myvar$none
	done
	rport=$rport$myvar
unset_value
timeout=`echo $timeout`
timeout_lenght=`echo $timeout | awk '{print length}'`
subtract_compare_value=`expr $greater_value - $timeout_lenght + 3`	
	for (( i = 0 ; i < $subtract_compare_value; i++ )) do
		myvar=$myvar$none
	done
	timeout=$timeout$myvar
unset_value
subtract_compare_value=`expr $greater_value - 17 + 4`
for (( i = 0 ; i < $subtract_compare_value; i++ )) do
		myvar=$myvar$none
	done
	i_characters=$i_characters$myvar
unset_value
subtract_compare_value=`expr $greater_value - 17 + 6`
for (( i = 0 ; i < $subtract_compare_value; i++ )) do
		myvar=$myvar$none
	done
	g_characters=$g_characters$myvar
unset_value
subtract_compare_value=`expr $greater_value - 16 + 5`
for (( i = 0 ; i < $subtract_compare_value; i++ )) do
		myvar=$myvar$none
	done
	_characters1=$_characters1$myvar
unset_value
subtract_compare_value=`expr $greater_value - 16 + 5`
for (( i = 0 ; i < $subtract_compare_value; i++ )) do
		myvar=$myvar$none
	done
	_characters2=$_characters2$myvar
unset_value

module_banner_2
}
function module_banner_1 {
if [ "$language" = "VN" ]; then
yes="  Có"
no="  Không"
cat << !

Các tùy chọn của mô-đun (auxiliary/scanner/smb/MS17-010_smb_scan):

   Tên       	  Thiết lập hiện tại 	Yêu cầu   Miêu tả
   ----           --------------- 	--------  -----------
   RHOSTS         $rhosts $yes       Địa chỉ hoặc tên miền của máy chủ mục tiêu
   RPORT          $rport $no	  Cổng dịch vụ máy chủ smb đang chạy.
   TIMEOUT        $timeout $no	  Thời gian chờ phiên kết nối.

!
elif [ "$language" = "EN" ]; then
yes="  yes"
no="  no "
cat << !

Module options (auxiliary/scanner/smb/MS17-010_smb_scan):

   Name           Current Setting 	Required  Description
   ----           --------------- 	--------  -----------
   RHOSTS         $rhosts $yes      Address or domain name of target server.
   RPORT          $rport $no	  The smb server service port is running.
   TIMEOUT        $timeout $no	  Session timeout.

!
fi	
}
function module_banner_2 {
if [ "$language" = "VN" ]; then
yes="  Có"
no="  Không"
cat << !

Các tùy chọn của mô-đun (auxiliary/scanner/smb/MS17-010_smb_scan):

   Tên       	  Thiết lập hiện tạ${i_characters}Yêu cầu   Miêu tả
   ----       	  ---------------${_characters1}--------  -----------
   RHOSTS         $rhosts $yes       Địa chỉ hoặc tên miền của máy chủ mục tiêu
   RPORT          $rport $no    Cổng dịch vụ máy chủ smb đang chạy.
   TIMEOUT        $timeout $no    Thời gian chờ phiên kết nối.

!
elif [ "$language" = "EN" ]; then
yes="  yes"
no="  no "
cat << !

Module options (auxiliary/scanner/smb/MS17-010_smb_scan):

   Name           Current Setting${g_characters}Required  Description
   ----           ---------------${_characters2}--------  -----------
   RHOSTS         $rhosts $yes      Address or domain name of target server.
   RPORT          $rport $no      The smb server service port is running.
   TIMEOUT        $timeout $no      Session timeout.

!
fi
		
}
function show_platforms {
if [ "$language" = "VN" ]; then
echo -e """
Nền tảng mã khai thác:

   Id  Tên
   --  ----
   0   ${BlueF}Py${yellow}thon${RESET}
"""
elif [ "$language" = "EN" ]; then
echo -e """
Exploit code platform:

   Id  Name
   --  ----
   0   ${BlueF}Py${yellow}thon${RESET}
"""
fi
}
function platform {
if [[ "$platform" = "python" ]] || [[ "$platform" = "PYTHON" ]] || [[ "$platform" = "Python" ]] || [[ "$platform" = "py" ]] || [[ "$platform" = "Py" ]] || [[ "$platform" = "0" ]]; then
	if [ "$language" = "VN" ]; then
echo -ne """
Nền tảng được chọn:

   Id  Tên
   --  ----
   0   ${BlueF}Py${yellow}thon${RESET}
"""
	elif [ "$language" = "EN" ]; then
echo -ne """
Platform selected:

   Id  Name
   --  ----
   0   ${BlueF}Py${yellow}thon${RESET}
"""
	fi
fi
}
################# targets ###################
#############################################
function show_targets {
if [ "$language" = "VN" ]; then
cat << !

Các mục tiêu có thể khai thác:

   Id  Tên
   --  ----
   0   Tự động điều chỉnh mục tiêu thông qua lấy dấu tay
       ,--------------------------------------------------------.
       |    Mục tiêu bao gồm các phiên bản Windows              |   
       |--------------------------------------------------------|
       |  Windows Server 2016 for x64-based Systems             |
       |  Windows 10 Version 1607 for 32-bit Systems            |
       |  Windows 10 Version 1607 for x64-based Systems         |
       |  Windows 10 version 1511 for 32-bit Systems            |
       |  Windows 10 version 1511 for x64-based Systems         |
       |  Windows 10 for 32-bit Systems                         |
       |  Windows 10 for x64-based Systems                      |
       |  Windows 7 for 32-bit Systems SP1                      |
       |  Windows 7 for x64-based Systems SP1                   |
       |  Windows 8 for x64-based Systems                       |
       |  Windows 8 for 32-bit Systems                          |
       |  Windows 8.1 for 32-bit Systems                        |
       |  Windows 8.1 for x64-based Systems                     |
       |  Windows RT 8.1                                        |
       |  Windows Server 2012                                   |
       |  Windows Server 2012 R2                                |
       |  Windows Server 2008 R2 for Itanium-based Systems SP1  |
       |  Windows Server 2008 R2 for x64-based Systems SP1      |
       |  Windows Server 2008 for 32-bit Systems SP2            |
       |  Windows Server 2008 for Itanium-based Systems SP2     |
       |  Windows Server 2008 for x64-based Systems SP2         |
       |  Windows Vista Service Pack 2                          |
       |  Windows Vista x64 Edition Service Pack 2              |
       |  Windows XP Embedded SP3 x86                           |
       |  Windows XP Sp2 X64                                    |
       |  Windows XP Sp3 X86                                    |
       |  Windows Server 2003 x64 SP2                           |
       |  Windows Server 2003 x86 SP2                           |
       '--------------------------------------------------------'  

!
elif [ "$language" = "EN" ]; then
cat << !

Exploit targets:

   Id  Name
   --  ----
   0   Automatic targeting via fingerprinting
       ,--------------------------------------------------------.
       |    Targets includes Windows versions                   |   
       |--------------------------------------------------------|
       |  Windows Server 2016 for x64-based Systems             |
       |  Windows 10 Version 1607 for 32-bit Systems            |
       |  Windows 10 Version 1607 for x64-based Systems         |
       |  Windows 10 version 1511 for 32-bit Systems            |
       |  Windows 10 version 1511 for x64-based Systems         |
       |  Windows 10 for 32-bit Systems                         |
       |  Windows 10 for x64-based Systems                      |
       |  Windows 7 for 32-bit Systems SP1                      |
       |  Windows 7 for x64-based Systems SP1                   |
       |  Windows 8 for x64-based Systems                       |
       |  Windows 8 for 32-bit Systems                          |
       |  Windows 8.1 for 32-bit Systems                        |
       |  Windows 8.1 for x64-based Systems                     |
       |  Windows RT 8.1                                        |
       |  Windows Server 2012                                   |
       |  Windows Server 2012 R2                                |
       |  Windows Server 2008 R2 for Itanium-based Systems SP1  |
       |  Windows Server 2008 R2 for x64-based Systems SP1      |
       |  Windows Server 2008 for 32-bit Systems SP2            |
       |  Windows Server 2008 for Itanium-based Systems SP2     |
       |  Windows Server 2008 for x64-based Systems SP2         |
       |  Windows Vista Service Pack 2                          |
       |  Windows Vista x64 Edition Service Pack 2              |
       |  Windows XP Embedded SP3 x86                           |
       |  Windows XP Sp2 X64                                    |
       |  Windows XP Sp3 X86                                    |
       |  Windows Server 2003 x64 SP2                           |
       |  Windows Server 2003 x86 SP2                           |
       '--------------------------------------------------------'  

!
fi
}

function target {
if [ "$language" = "VN" ]; then
cat << !
Mục tiêu khai thác:

   Id  Tên
   --  ----
   0   Tự động điều chỉnh mục tiêu thông qua lấy dấu tay

!
elif [ "$language" = "EN" ]; then
cat << !
Exploit target:

   Id  Name
   --  ----
   0   Automatic targeting via fingerprinting

!
fi
}
################# payload list ###################
#############################################
function payload_list {
echo -n ""
}
function out_value {
rhosts=`echo $rhosts`
rport=`echo $rport`
timeout=`echo $timeout`
file_ip="ip.txt"
file_attack_ip="attack_ip.txt"
}
function check {
echo -e "[${red}-${RESET}] $not_module_check"
}
function module_run {
echo -n ""
}
function attack {
#####################
path_present=`pwd`
###################
out_value
path_tool="../../Tools/Vulnerability-Exploit/MS17-010/"
cd $path_tool
rm -rf $file_ip > /dev/null 2>&1
touch $file_ip > /dev/null 2>&1
rm -rf $file_attack_ip > /dev/null 2>&1
touch $file_attack_ip > /dev/null 2>&1
check_none_rhosts=`echo $rhosts`
check_rhosts=`echo $rhosts | grep -e ";"`
if [[ "$check_rhosts" != "" ]]; then
  check_run=1
	for (( i = 1 ; i <= 1000000; i++ )) do
		new_rhosts=`echo $rhosts | cut -d';' -f$i`
		if [[ "$new_rhosts" != "" ]]; then
      if [[ "$new_rhosts" =~ ^(([1-9]?[0-9]|1[0-9][0-9]|2([0-4][0-9]|5[0-5]))\.){3}([1-9]?[0-9]|1[0-9][0-9]|2([0-4][0-9]|5[0-5]))$ ]]; then
			 echo "$new_rhosts" >> $file_ip
      else
        echo -e "${red}[-]$RESET $new_rhosts $not_format"
      fi
		else
			break
		fi
	done		
elif [[ "$check_rhosts" = "" ]]; then
	if [[ "$check_none_rhosts" != "" ]]; then
		rhosts_analysis=${rhosts##*.} > /dev/null 2>&1
		head_rhosts=${rhosts%.*} > /dev/null 2>&1
		start_num=`echo $rhosts_analysis | cut -d'/' -f1` > /dev/null 2>&1
		stop_num=`echo $rhosts_analysis | cut -d'/' -f2` > /dev/null 2>&1
		if [ "$stop_num" != "" ]; then
			stop_num=`echo $stop_num` > /dev/null 2>&1
		else
			stop_num="0"
		fi
    if [[ "$rhosts_analysis" != "" ]]; then
      check_run=1
  		check_num=`expr $start_num + $stop_num` > /dev/null 2>&1
      value_check_num=`expr $start_num \* 2`
  		if [ "$check_num" = "$value_check_num" ] || [ "$check_num" = "$start_num" ]; then
        if [[ "$rhosts" =~ ^(([1-9]?[0-9]|1[0-9][0-9]|2([0-4][0-9]|5[0-5]))\.){3}([1-9]?[0-9]|1[0-9][0-9]|2([0-4][0-9]|5[0-5]))$ ]]; then
    			echo "$rhosts" >> $file_ip
        else
          check_run=0
          echo -e "${red}[-]$RESET $rhosts $not_format"
        fi
  		else
        if [[ "$head_rhosts.$start_num" =~ ^(([1-9]?[0-9]|1[0-9][0-9]|2([0-4][0-9]|5[0-5]))\.){3}([1-9]?[0-9]|1[0-9][0-9]|2([0-4][0-9]|5[0-5]))$ ]] || [[ "$head_rhosts.$stop_num" =~ ^(([1-9]?[0-9]|1[0-9][0-9]|2([0-4][0-9]|5[0-5]))\.){3}([1-9]?[0-9]|1[0-9][0-9]|2([0-4][0-9]|5[0-5]))$ ]]; then
    			for (( i = $start_num ; i <= $stop_num; i++ )) do
    				new_rhosts="$head_rhosts.$i"
    				echo "$new_rhosts" >> $file_ip
    			done
        else
          check_run=0
          echo -e "${red}[-]$RESET $head_rhosts.$start_num/$stop_num $not_format"
        fi
  		fi
    else
      check_run=0
      echo -e "${red}[-]$RESET $rhosts $not_format"
    fi
	fi
fi
if [[ "$check_run" = "1" ]]; then
  echo -e "${BlueF}[*]$RESET $scan_start"
  bash checkvuln.sh -p $rport -t $timeout
  echo -e "${BlueF}[*]$RESET $scan_stop"
fi
cd $path_present
}
